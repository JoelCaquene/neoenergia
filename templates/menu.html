{% extends "base.html" %}
{% load static %}

{% block title %}Menu{% endblock %}

{% block content %}
<style>
    /* O CSS foi mantido o mesmo da sua 칰ltima vers칚o, incluindo as corre칞칫es de 칤cone, para n칚o introduzir novos erros de estilo. */
    /* ---------------------- CSS DE AJUSTE GERAL E CORES ---------------------- */
    /* Fundo principal da p치gina (claro, mas o conte칰do 칠 escuro) */
    body {
        background-color: #f7f7f7 !important;
        overflow-x: hidden;
    }
    .container {
        padding: 0;
        padding-bottom: 70px; /* Espa칞o para o footer */
        background-color: transparent !important;
    }
    /* Esconder o header e navega칞칚o padr칚o que n칚o s칚o usados neste layout */
    .menu-header, .news-marquee-container {
        display: none !important;
    }

    /* Cor principal do fundo dos blocos (Dark Blue/Navy) */
    .dark-bg {
        background-color: #1a3359;
    }
    .header-box {
        background-color: #1a3359;
        color: white;
        padding: 15px;
        position: relative;
    }
    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    .logo-section {
        display: flex;
        align-items: center;
    }
    .logo-section img {
        height: 35px; /* Tamanho do logo ajustado */
        margin-right: 8px;
    }
    .logo-section h1 {
        font-size: 1.5rem;
        font-weight: 800;
        color: white; /* Cor do fundo do bloco */
        margin: 0;
    }

    .avatar-section {
        text-align: center;
        position: relative;
    }
    .avatar-placeholder {
        width: 50px;
        height: 50px;
        background-color: #fff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 5px auto;
        border: 2px solid white;
    }
    .avatar-placeholder i {
        font-size: 2rem;
        color: #1a3359;
    }
    .avatar-section span {
        display: block;
        font-size: 0.7rem;
        font-weight: 500;
        color: white;
    }

    .balance-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding: 5px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .balance-item {
        text-align: left;
        flex: 1;
    }
    .balance-item:last-child {
        text-align: right;
    }
    .balance-item p {
        margin: 0;
        font-size: 0.8rem;
        font-weight: 300;
        color: #ccc;
    }
    .balance-item strong {
        display: block;
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 2px;
        color: white;
    }
    .balance-item .level {
        color: #ffcc00; /* Destaque para o N칤vel */
    }


    /* ---------------------- SE칂츾O DE BOT칏ES DE A칂츾O (4 COLUNAS) ---------------------- */
    .action-grid {
        display: flex;
        justify-content: space-around;
        padding: 15px 0;
        margin: 0 15px; /* Ajuste para centralizar no bloco */
    }
    .action-item {
        flex: 1;
        text-align: center;
        text-decoration: none;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 5px 0;
    }
    .action-icon-box {
        width: 45px;
        height: 45px;
        background-color: rgba(255, 255, 255, 0.15); /* Fundo sutil */
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 5px;
    }
    .action-icon-box i {
        font-size: 1.3rem;
        color: #ffcc00; /* Cor amarela/dourada para os 칤cones */
    }
    .action-item span {
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* ---------------------- SE칂츾O DA ROLETA ---------------------- */
    .roulette-section-box {
        background-color: #1a3359;
        margin: 15px 0;
        padding: 15px;
        border-radius: 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .roulette-title {
        font-size: 1rem;
        font-weight: 700;
        color: white;
        flex: 1;
    }
    .roulette-image-box {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .roulette-image-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Anima칞칚o da roleta */
    .spinning {
           animation: spinning 4s linear infinite;
    }
    @keyframes spinning {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }


    /* ---------------------- SE칂츾O DE CONVITE ---------------------- */
    .invite-section-box {
        background-color: #1a3359;
        margin: 15px 0;
        padding: 15px;
        color: white;
    }
    .invite-section-box h3 {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #ffcc00;
    }
    .invite-box-custom {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        border: 1px dashed rgba(255, 255, 255, 0.3);
    }
    .invite-box-custom span {
        flex-grow: 1;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis; /* Adiciona '...' se o texto for muito longo */
        min-width: 0;
        margin-right: 10px;
        font-size: 0.9rem;
        color: white;
    }
    .copy-button {
        background-color: #007bff; color: #fff; border: none; padding: 5px 10px;
        border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; white-space: nowrap;
        font-size: 0.8rem;
    }


    /* ---------------------- RODAP칄 (FOOTER) ---------------------- */
    .footer-menu-new {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
        background-color: #1a3359; /* Cor do fundo dos blocos */
        border-top: 1px solid #000;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        z-index: 500;
        height: 60px;
    }
    .footer-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #999;
        padding: 5px 0;
        flex-grow: 1;
        transition: color 0.3s;
    }
    .footer-item:hover, .footer-item.active {
        color: #ffcc00; /* Cor de destaque */
    }
    .footer-item i {
        font-size: 1.3rem;
        margin-bottom: 2px;
    }
    .footer-item span {
        font-size: 0.7rem;
        font-weight: 600;
    }

    /* ---------------------- POP-UP CUSTOMIZADO (ESTILOS NECESS츼RIOS) ---------------------- */
    .popup-overlay {
        display: none; /* Inicia escondido, ser치 exibido via JS */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .popup-content {
        background-color: #fff;
        border-radius: 10px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    .popup-header {
        height: 10px !important;
        background-color: #1a3359 !important;
        overflow: hidden;
    }
    .popup-body {
        padding: 20px;
        text-align: center;
    }
    .popup-title {
        color: #1a3359 !important;
        margin-top: 5px !important;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .welcome-text {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 15px 0;
    }
    .popup-close-button {
        background-color: #1a3359 !important;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        margin-top: 15px;
    }
    .social-links {
        margin-top: 15px;
    }
    .social-button {
        display: block;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .whatsapp-social {
        background-color: #25d366;
        color: white;
    }
    .whatsapp-social i {
        margin-right: 8px;
    }
    .telegram-social { display: none !important; } /* Remover Telegram do pop-up */

</style>

{# ---------------------- HEADER PRINCIPAL (Dark Blue) ---------------------- #}
<div class="header-box">
    <div class="header-top">
        <div class="logo-section">
            <img src="{% static 'images/neoleaf.png' %}" alt="Logo Neoenergia">
            <h1>NEOENERGIA</h1>
        </div>
        <a href="{% url 'perfil' %}" class="avatar-section">
            <div class="avatar-placeholder">
                <i class="fa-solid fa-user-tie"></i>
            </div>
            <span>AVATAR</span>
        </a>
    </div>

    {# Saldo e N칤vel #}
    <div class="balance-info">
        <div class="balance-item">
            <p>SALDO ACTIVO</p>
            <strong>{{ user.available_balance|default:"0.00" }} KZ</strong>
        </div>
        <div class="balance-item">
            <p>N칈VEL</p>
            <strong class="level">{{ user.active_level.name|default:"Nenhum" }}</strong>
        </div>
    </div>
</div>

{# ---------------------- BOT칏ES DE A칂츾O (4 COLUNAS) ---------------------- #}
<div class="dark-bg">
    <div class="action-grid">
        <a href="{% url 'deposito' %}" class="action-item">
            <div class="action-icon-box"><i class="fa-solid fa-wallet"></i></div>
            <span>Dep칩sito</span>
        </a>
        <a href="{% url 'saque' %}" class="action-item">
            {# 칈cone de Saque CORRIGIDO #}
            <div class="action-icon-box"><i class="fa-solid fa-hand-holding-dollar"></i></div>
            <span>Saque</span>
        </a>
        <a href="{% url 'equipa' %}" class="action-item">
            <div class="action-icon-box"><i class="fa-solid fa-users"></i></div>
            <span>Equipa</span>
        </a>
        <a href="{% url 'tarefa' %}" class="action-item">
            <div class="action-icon-box"><i class="fa-solid fa-clipboard-list"></i></div>
            <span>Tarefa</span>
        </a>
    </div>
</div>

{# ---------------------- SE칂츾O DA ROLETA ---------------------- #}
<a href="{% url 'roleta' %}" class="roulette-section-box">
    <div class="roulette-title">
        A SUA ROLETA
    </div>
    <div class="roulette-image-box">
        <img src="{% static 'images/roulette_wheel_animated.png' %}" alt="Roda da Sorte" class="roulette-image spinning" id="rouletteImage">
    </div>
</a>

{# ---------------------- SE칂츾O DE CONVITE (CORRIGIDA PARA C칍PIA) ---------------------- #}
<div class="invite-section-box">
    <a href="{% url 'equipa' %}" style="text-decoration: none; color: inherit;">
        <h3>Convide Amigos e Ganhe Comiss칚o</h3>
    </a>

    {# Estrutura de C칩pia Interativa #}
    <div class="invite-box-custom">
        <span id="invite-link-menu">
            {{ invite_link|default:"[Link N칚o Dispon칤vel]" }}
        </span>
        <button id="copyLinkButton" class="copy-button">
            <i class="fas fa-copy"></i> Copiar
        </button>
    </div>
</div>

{# ---------------------- BARRA DE NAVEGA칂츾O INFERIOR ---------------------- #}
<nav class="footer-menu-new">
    <a href="{% url 'menu' %}" class="footer-item active">
        <i class="fa-solid fa-house"></i>
        <span>Menu</span>
    </a>
    <a href="{% url 'nivel' %}" class="footer-item">
        <i class="fa-solid fa-chart-area"></i>
        <span>N칤vel</span>
    </a>
    <a href="{% url 'sobre' %}" class="footer-item">
        <i class="fa-solid fa-info-circle"></i>
        <span>Sobre</span>
    </a>
    <a href="{% url 'perfil' %}" class="footer-item">
        <i class="fa-solid fa-user-circle"></i>
        <span>Perfil</span>
    </a>
</nav>

{# ---------------------- POP-UP DE BOAS-VINDAS (REINTRODUZIDO) ---------------------- #}
<div id="welcomePopup" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-header"></div>
        <div class="popup-body">
            <h2 class="popup-title">游녦 SEJA BEM VINDO (A)</h2>
            <p class="popup-text welcome-text">
                Para suporte, acesse o nosso canal oficial no WhatsApp!
            </p>
            <div class="social-links">
                {% if whatsapp_link %}
                    <a href="{{ whatsapp_link }}" target="_blank" class="social-button whatsapp-social">
                        <i class="fa-brands fa-whatsapp"></i> WhatsApp
                    </a>
                {% endif %}
            </div>
            <button id="closePopup" class="popup-close-button">Continuar</button>
        </div>
    </div>
</div>

<script>
    // Fun칞칚o de fallback para c칩pia usando document.execCommand
    function fallbackCopyTextToClipboard(text) {
        let successful = false;
        try {
            // Cria um elemento de texto tempor치rio
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // Estiliza para fora da tela
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            successful = document.execCommand('copy');
            document.body.removeChild(textArea);
        } catch (err) {
            console.error('Fallback: Falha ao copiar!', err);
            successful = false;
        }
        return successful;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // L칩gica de Anima칞칚o para a Roleta
        const rouletteImage = document.getElementById('rouletteImage');
        if (rouletteImage) {
            rouletteImage.classList.add('spinning');
        }

        // L칩gica para Copiar Link - CORRIGIDO com Fallback
        const copyButton = document.getElementById('copyLinkButton');
        const linkElement = document.getElementById('invite-link-menu');

        // Fun칞칚o unificada para gerenciar o feedback visual
        function showCopyFeedback(button, success) {
            const originalText = '<i class="fas fa-copy"></i> Copiar';
            const originalBg = '#007bff';

            if (success) {
                button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                button.style.backgroundColor = '#28a745'; // Verde para sucesso
            } else {
                // Se falhar, n칚o mudamos para "Copiado", mas mostramos o alerta e voltamos a cor
                button.innerHTML = originalText;
                button.style.backgroundColor = originalBg;
                alert('Erro ao copiar o link. Tente copiar manualmente.');
                return;
            }

            // Volta ao estado original ap칩s 2 segundos
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.backgroundColor = originalBg;
            }, 2000);
        }


        if (copyButton && linkElement) {
            copyButton.addEventListener('click', function(e) {
                const textToCopy = linkElement.innerText.trim();

                if (textToCopy === '[Link N칚o Dispon칤vel]' || textToCopy === '' || textToCopy === null) {
                    alert('Erro: O link de convite n칚o est치 dispon칤vel.');
                    return;
                }

                // Tenta usar a API moderna de Clipboard
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            showCopyFeedback(e.currentTarget, true);
                        })
                        .catch(err => {
                            // Se a API moderna falhar, usa o fallback (execCommand)
                            console.warn('Falha na API moderna de Clipboard. Tentando fallback.', err);
                            const success = fallbackCopyTextToClipboard(textToCopy);
                            showCopyFeedback(e.currentTarget, success);
                        });
                } else {
                    // Usa o fallback diretamente se a API moderna n칚o estiver dispon칤vel (HTTP)
                    const success = fallbackCopyTextToClipboard(textToCopy);
                    showCopyFeedback(e.currentTarget, success);
                }
            });
        }

        // L칩gica do Pop-up de Boas-Vindas
        const popup = document.getElementById('welcomePopup');
        const closeButton = document.getElementById('closePopup');

        // **MODIFICA칂츾O AQUI: Pop-up aparece sempre, sem localStorage**
        if (popup) {
            setTimeout(() => {
                popup.style.display = 'flex';
            }, 100);
        }

        // Fechar ao clicar no bot칚o
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                popup.style.display = 'none';
            });
        }

        // Fechar ao clicar fora do conte칰do
        window.addEventListener('click', (event) => {
            if (event.target === popup) {
                popup.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}Levantamento Personalizado | ATM Financeiro{% endblock %}

{% block content %}
<div class="page-header-app">
    <div class="header-content">
        <i class="fas fa-money-check-alt header-icon"></i>
        <h1>LEVANTAMENTO</h1> 
    </div>
</div>

<div class="app-container-finance">
    {# √Årea de Mensagens Django #}
    {% if messages %}
        <ul class="messages-app-finance">
            {% for message in messages %}
                <li class="{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}"><i class="fas fa-bell"></i> {{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    {# NOVO CARD DE SALDO - Fundo Preto, Movido para o Topo #}
    <div class="card-balance-new">
        <div class="balance-header">
            <i class="fas fa-wallet card-icon"></i>
            <p class="balance-label">Seu Saldo Dispon√≠vel</p>
        </div>
        <p class="balance-amount">{{ user.available_balance|default:"0.00" }} KZ</p>
        
        {# Alerta de Dados Banc√°rios #}
        <div class="card-details">
            {% if not has_bank_details %}
                <div class="alert-bank-required">
                    <i class="fas fa-exclamation-circle"></i>
                    **Aten√ß√£o:** Dados banc√°rios pendentes. Atualize no seu <a href="{% url 'perfil' %}" class="link-action-bank">Perfil</a>.
                </div>
            {% else %}
                <div class="alert-bank-ok">
                    <i class="fas fa-check-circle"></i>
                    **Dados Banc√°rios:** Configurados.
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="main-workspace-new">
        {# üß≠ Navega√ß√£o de Abas (Separadores) Horizontal e Simplificada #}
        <div class="tabs-navigation-bottom">
            <button class="tab-button-bottom active" onclick="openTab(event, 'realizar-saque')">
                <i class="fas fa-file-invoice-dollar"></i> Solicitar Levantamento
            </button>
            <button class="tab-button-bottom" onclick="openTab(event, 'historico')">
                <i class="fas fa-list-alt"></i> Hist√≥rico de Levantamentos {# T√≠tulo alterado para ser mais geral #}
            </button>
        </div>

        <div class="tabs-content-area-finance">
            
            {# 1¬∫ Separador: Formul√°rio de Saque #}
            <div id="realizar-saque" class="tab-pane active">
                {% if not has_bank_details or already_withdrawn_today or not is_time_allowed %}
                    {# NOVO BLOQUEIO - Mais Direto e Personalizado #}
                    <div class="card-message-overlay-new">
                        <i class="fas fa-lock"></i>
                        <h2>LEVANTAMENTO BLOQUEADO</h2>
                        <p>Verifique os seguintes requisitos para continuar:</p>
                        <ul>
                            {% if not has_bank_details %}<li><i class="fas fa-university"></i> **Dados Banc√°rios:** √â obrigat√≥rio configurar suas coordenadas banc√°rias no <a href="{% url 'perfil' %}" class="link-action-bank">Perfil</a>.</li>{% endif %}
                            {% if already_withdrawn_today %}<li><i class="fas fa-calendar-times"></i> **Limite Di√°rio:** Voc√™ j√° realizou um levantamento hoje. Permiss√£o de um saque por dia.</li>{% endif %}
                            {% if not is_time_allowed %}<li><i class="fas fa-clock"></i> **Hor√°rio:** Saques s√£o processados apenas das 09:00h √†s 18:00h (GMT+1).</li>{% endif %}
                            <li><i class="fas fa-search-dollar"></i> **M√≠nimo por Levantamento:** {{ min_withdrawal_amount|default:"2000.00" }} KZ.</li>
                        </ul>
                    </div>
                {% else %}
                    <form method="post" class="saque-form-app">
                        {% csrf_token %}
                        
                        {# Campo de Entrada #}
                        <div class="form-group-app input-group-personalizado">
                            <label for="{{ form.amount.id_for_label }}" class="label-personalizado">Valor do Levantamento (KZ)</label>
                            <div class="input-icon-wrapper-personalizado">
                                <i class="fas fa-hand-holding-usd icon-input-left"></i>
                                <input type="number" 
                                        name="{{ form.amount.name }}" 
                                        id="{{ form.amount.id_for_label }}" 
                                        placeholder="M√≠nimo de {{ min_withdrawal_amount|default:'2000' }} KZ" 
                                        min="{{ min_withdrawal_amount|default:'2000' }}" 
                                        step="0.01"
                                        required
                                        class="input-personalizado">
                                <span class="currency-tag-personalizado">KZ</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="button-submit-app button-personalizado">
                            <i class="fas fa-paper-plane"></i> ENVIAR SOLICITA√á√ÉO DE LEVANTAMENTO
                        </button>
                        
                        <p class="note-saque"><i class="fas fa-info-circle"></i> O processamento √© realizado em at√© **24 horas √∫teis**.</p>
                    </form>
                {% endif %}
            </div>

            {# 2¬∫ Separador: Hist√≥rico de Saques - CORRIGIDO PARA MOSTRAR TODOS OS STATUS #}
            <div id="historico" class="tab-pane">
                <div class="card-history">
                    <h2><i class="fas fa-history"></i> Seus Registos de Levantamentos</h2>
                    {% if withdrawal_records %}
                        <div class="history-list-app-new">
                            
                            {% for record in withdrawal_records %}
                                {# Normaliza o status para usar em classes CSS e l√≥gica de compara√ß√£o #}
                                {% with status_normalized=record.status|lower %}
                                
                                    {# Mapeamento de Status para Portugu√™s e √çcone #}
                                    {% if status_normalized == 'pending' %}
                                        {% with status_texto="Pendente" status_icone="fas fa-hourglass-half" %}
                                    {% elif status_normalized == 'aprovado' or status_normalized == 'approved' %}
                                        {% with status_texto="Aprovado" status_icone="fas fa-check-circle" %}
                                    {% elif status_normalized == 'rejeitado' or status_normalized == 'rejected' %}
                                        {% with status_texto="Rejeitado" status_icone="fas fa-times-circle" %}
                                    {% else %}
                                        {% with status_texto="Desconhecido" status_icone="fas fa-question-circle" status_normalized="unknown" %} {# Fallback para status 'unknown' para a classe CSS #}
                                    {% endif %}
                                    
                                    <div class="transaction-item-new status-{{ status_normalized }}">
                                        <div class="icon-illustration">
                                            <i class="{{ status_icone }}"></i>
                                        </div>
                                        <div class="transaction-details-new">
                                            <span class="transaction-type-new">
                                                Levantamento: {{ status_texto }}
                                            </span>
                                            <span class="transaction-date-new">{{ record.created_at|date:"d/m/Y H:i" }}</span>
                                        </div>
                                        <span class="transaction-amount-new amount-{{ status_normalized }}">- {{ record.amount|default:"0.00" }} KZ</span> {# O saque √© uma sa√≠da, usamos o sinal de menos #}
                                        <div class="status-tag-new tag-{{ status_normalized }}">
                                            <i class="{{ status_icone }}"></i> {{ status_texto }}
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endwith %}

                            {% endfor %}

                        </div>
                    {% else %}
                        <div class="alert-box-finance info-border">
                            <i class="fas fa-info-circle"></i> N√£o h√° registos de saques recentes.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- V4.2: Estilos Personalizados e Profissionais (Com l√≥gica de status no CSS) --- */
    
    /* Estrutura Base */
    body {
        background-color: #f4f6f9; 
        font-family: 'Open Sans', sans-serif;
        color: #333;
    }
    
    /* Container Principal da Aplica√ß√£o */
    .app-container-finance {
        max-width: 900px;
        margin: -40px auto 30px; 
        background-color: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column; 
        overflow: hidden;
    }

    /* Cabe√ßalho da Aplica√ß√£o (Onde est√° 'LEVANTAMENTO') */
    .page-header-app {
        padding: 20px 0;
        text-align: center;
        background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
        color: #fff;
    }
    .header-content {
        display: inline-flex;
        align-items: center;
    }
    .header-icon {
        font-size: 2rem;
        margin-right: 15px;
        color: #fff;
    }
    .page-header-app h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .main-workspace-new {
        display: flex;
        flex-direction: column;
        min-height: 400px;
    }

    /* --- CARD DE SALDO (Topo, Fundo Escuro) --- */
    .card-balance-new {
        background: #2c3e50; 
        padding: 25px 30px;
        color: #fff;
        text-align: left;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
    }
    .balance-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        opacity: 0.8;
    }
    .card-icon {
        font-size: 1.5rem;
        margin-right: 10px;
    }
    .balance-label {
        font-size: 1rem;
        margin: 0;
        font-weight: 300;
    }
    .balance-amount {
        font-size: 3rem;
        font-weight: 800;
        margin: 0 0 15px;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }
    .card-details {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 10px;
    }
    /* Estilo para status OK (novo) */
    .alert-bank-ok {
        color: #2ecc71; /* Verde */
        font-size: 0.95rem;
        font-weight: 600;
    }
    .alert-bank-ok i {
        margin-right: 5px;
    }
    .alert-bank-required {
        color: #f39c12; /* Laranja para pend√™ncia */
        font-size: 0.95rem;
        font-weight: 600;
    }
    .alert-bank-required i {
        margin-right: 5px;
    }
    .link-action-bank {
        color: #00c6ff; 
        text-decoration: underline;
        font-weight: 700;
    }

    /* --- Navega√ß√£o de Abas Inferiores (Simplificada) --- */
    .tabs-navigation-bottom {
        display: flex;
        width: 100%;
        background-color: #f4f6f9; 
        border-bottom: 1px solid #ddd;
    }
    .tab-button-bottom {
        flex: 1;
        background: none;
        border: none;
        padding: 18px 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        color: #7f8c8d; 
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        text-transform: uppercase;
    }
    .tab-button-bottom:hover {
        background-color: #eee;
    }
    .tab-button-bottom.active {
        color: #6a11cb; 
        border-bottom: 3px solid #6a11cb;
        background-color: #ffffff;
    }
    .tab-button-bottom i {
        margin-right: 8px;
    }

    /* √Årea de Conte√∫do */
    .tabs-content-area-finance {
        flex: 1;
        padding: 30px;
        background-color: #ffffff;
    }

    /* --- ESTILOS PROFISSIONAIS PARA O FORMUL√ÅRIO DE SAQUE/LEVANTAMENTO --- */
    .saque-form-app {
        display: flex;
        flex-direction: column;
        gap: 25px;
        max-width: 500px; 
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
    }
    .label-personalizado {
        display: block;
        margin-bottom: 8px;
        font-weight: 700;
        color: #34495e; 
        font-size: 1rem;
    }
    .input-icon-wrapper-personalizado {
        position: relative;
        display: flex;
        align-items: center;
    }
    .icon-input-left {
        position: absolute;
        left: 15px;
        color: #6a11cb; 
        font-size: 1.2rem;
        pointer-events: none; 
    }
    .currency-tag-personalizado {
        position: absolute;
        right: 15px;
        color: #7f8c8d; 
        font-weight: 700;
        font-size: 1rem;
    }
    .input-personalizado {
        width: 100%;
        padding: 15px 60px 15px 45px; 
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .input-personalizado:focus {
        border-color: #6a11cb;
        box-shadow: 0 0 8px rgba(106, 17, 203, 0.4);
        outline: none;
    }
    .button-personalizado {
        background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); 
        color: white;
        border: none;
        padding: 18px 25px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        transition: opacity 0.3s, transform 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .button-personalizado:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    .button-personalizado i {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    .note-saque {
        text-align: center;
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 1px dashed #eee;
    }
    .note-saque i {
        color: #3498db;
        margin-right: 5px;
    }

    /* Novo Bloqueio de Mensagem */
    .card-message-overlay-new {
        text-align: center;
        padding: 30px 20px;
        background: linear-gradient(145deg, #fce7e7, #fff0f0);
        border: 2px solid #e74c3c;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2);
    }
    .card-message-overlay-new i {
        font-size: 2.5rem;
        color: #e74c3c;
        margin-bottom: 15px;
    }
    .card-message-overlay-new h2 {
        color: #e74c3c;
        font-size: 1.4rem;
        margin-top: 0;
    }
    .card-message-overlay-new p {
        font-size: 1rem;
        color: #c0392b;
        margin-bottom: 20px;
    }
    .card-message-overlay-new ul {
        list-style: none;
        padding: 0;
        text-align: left;
        display: inline-block;
        max-width: 450px;
    }
    .card-message-overlay-new li {
        margin-top: 10px;
        color: #a94442;
        font-size: 0.95rem;
        display: flex;
        align-items: flex-start;
    }
    .card-message-overlay-new li i {
        font-size: 1rem;
        margin-right: 10px;
        margin-top: 4px;
        color: #e74c3c;
    }


    /* --- Hist√≥rico Personalizado (L√≥gica de Status CSS) --- */
    .history-list-app-new {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .transaction-item-new {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s;
        border-left: 5px solid #bdc3c7; /* Cinza Padr√£o */
    }
    .transaction-item-new:hover {
        transform: translateY(-2px);
    }
    .icon-illustration {
        font-size: 2rem;
        margin-right: 20px;
        color: #6a11cb; 
    }
    .transaction-details-new {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .transaction-type-new {
        font-weight: 700;
        color: #34495e; 
        font-size: 1.1rem;
    }
    .transaction-date-new {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    .transaction-amount-new {
        font-weight: 800;
        color: #333; 
        font-size: 1.2rem;
        margin-right: 15px;
    }
    .status-tag-new {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        background-color: #bdc3c7; /* Cinza Padr√£o */
        color: #fff;
        display: flex;
        align-items: center;
        min-width: 100px; /* Ajuda a manter o layout */
        justify-content: center;
    }
    .status-tag-new i {
        margin-right: 5px;
    }
    
    /* === ESTILOS POR STATUS === */
    /* Aprovado */
    .transaction-item-new.status-aprovado,
    .transaction-item-new.status-approved {
        border-left-color: #2ecc71; /* Verde */
    }
    .transaction-item-new.status-aprovado .icon-illustration,
    .transaction-item-new.status-approved .icon-illustration {
        color: #2ecc71;
    }
    .transaction-item-new.status-aprovado .transaction-type-new,
    .transaction-item-new.status-approved .transaction-type-new {
        color: #2ecc71;
    }
    .transaction-amount-new.amount-aprovado,
    .transaction-amount-new.amount-approved {
        color: #2ecc71;
    }
    .status-tag-new.tag-aprovado,
    .status-tag-new.tag-approved {
        background-color: #2ecc71;
    }
    
    /* Pendente */
    .transaction-item-new.status-pending {
        border-left-color: #f39c12; /* Amarelo/Laranja */
    }
    .transaction-item-new.status-pending .icon-illustration {
        color: #f39c12;
    }
    .transaction-item-new.status-pending .transaction-type-new {
        color: #f39c12;
    }
    .transaction-amount-new.amount-pending {
        color: #f39c12;
    }
    .status-tag-new.tag-pending {
        background-color: #f39c12;
    }
    
    /* Rejeitado */
    .transaction-item-new.status-rejeitado,
    .transaction-item-new.status-rejected {
        border-left-color: #e74c3c; /* Vermelho */
    }
    .transaction-item-new.status-rejeitado .icon-illustration,
    .transaction-item-new.status-rejected .icon-illustration {
        color: #e74c3c;
    }
    .transaction-item-new.status-rejeitado .transaction-type-new,
    .transaction-item-new.status-rejected .transaction-type-new {
        color: #e74c3c;
    }
    .transaction-amount-new.amount-rejeitado,
    .transaction-amount-new.amount-rejected {
        color: #e74c3c;
    }
    .status-tag-new.tag-rejeitado,
    .status-tag-new.tag-rejected {
        background-color: #e74c3c;
    }
    
    /* Desconhecido (Adicionado) */
    .transaction-item-new.status-unknown {
        border-left-color: #7f8c8d; /* Cinza Escuro */
    }
    .transaction-item-new.status-unknown .icon-illustration {
        color: #7f8c8d;
    }
    .transaction-amount-new.amount-unknown {
        color: #7f8c8d;
    }
    .status-tag-new.tag-unknown {
        background-color: #7f8c8d;
    }

    /* Media Queries */
    @media (max-width: 768px) {
        .card-balance-new {
            border-radius: 0;
            padding: 20px 15px;
        }
        .balance-amount {
            font-size: 2.5rem;
        }
        .transaction-item-new {
            flex-wrap: wrap;
            gap: 10px;
        }
        .transaction-amount-new {
            order: 3; 
            width: 100%;
            text-align: right;
            margin-right: 0;
        }
        .status-tag-new {
            order: 4; 
        }
        .icon-illustration {
            font-size: 1.5rem;
        }
        .input-personalizado {
            font-size: 1.1rem;
            padding: 12px 60px 12px 45px;
        }
        .button-personalizado {
            font-size: 1rem;
            padding: 15px 20px;
        }
    }
</style>

<script>
    // Fun√ß√£o JavaScript para controlar a troca de abas (L√≥gica original mantida)
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;

        // 1. Esconde todos os conte√∫dos das abas
        tabcontent = document.getElementsByClassName("tab-pane");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // 2. Remove a classe 'active' de todos os bot√µes de aba
        tablinks = document.getElementsByClassName("tab-button-bottom");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // 3. Mostra a aba atual e adiciona a classe 'active' ao bot√£o clicado
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // Inicializa a p√°gina abrindo a primeira aba ('realizar-saque')
    document.addEventListener("DOMContentLoaded", function() {
        const firstTabContent = document.getElementById("realizar-saque");
        const firstTabButton = document.querySelector(".tab-button-bottom:first-child");
        
        if (firstTabContent && firstTabButton) {
            firstTabContent.style.display = "block";
            firstTabButton.classList.add("active");
        }
    });
</script>
{% endblock %}

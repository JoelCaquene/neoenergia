{% extends "base.html" %}
{% load static %}

{% block title %}Dep√≥sito{% endblock %}

{% block content %}
<div class="page-header">
    <h1>DEP√ìSITO</h1>
</div>

{% if deposit_success %}
    {# ---------------------- TELA DE SUCESSO ---------------------- #}
    <div class="success-screen">
        {# Usando um √≠cone Font Awesome para evitar depend√™ncia de imagem local, mas se tiver a 'success_icon.png', pode mant√™-la. #}
        <i class="fas fa-check-circle success-icon-custom"></i>
        <h2>Dep√≥sito Enviado com Sucesso! ‚úÖ</h2>
        <p>Aguarde a aprova√ß√£o. O seu dep√≥sito est√° a ser processado e ser√° confirmado em 5 a 45 minutos.</p>
        <a href="{% url 'menu' %}" class="submit-button back-to-menu-button">Voltar ao Menu</a>
    </div>
{% else %}
    <div class="page-content">
        {# O indicador de etapas foi redesenhado para seguir o fluxo JackPay, usando apenas n√∫meros e texto. #}
        <div class="step-indicator-jackpay">
            <div class="step-item">
                <div class="step-circle active" id="indicator-1">1</div>
                <span>Escolher</span>
            </div>
            <div class="step-line"></div>
            <div class="step-item">
                <div class="step-circle" id="indicator-2">2</div>
                <span>Pagar</span>
            </div>
            <div class="step-line"></div>
            <div class="step-item">
                <div class="step-circle" id="indicator-3">3</div>
                <span>Comprovativo</span>
            </div>
        </div>

        <form id="deposit-form" method="post" enctype="multipart/form-data" class="form-style">
            {% csrf_token %}
            {# Campo escondido para o valor selecionado #}
            <input type="hidden" name="{{ form.amount.name }}" id="id_amount" value="">
            
            {# Campo escondido para o nome do pagador (Adicionado ao passo 3, mas o Django precisa dele) #}
            <input type="hidden" name="{{ form.payer_name.name }}" id="id_payer_name_hidden" value="">
            
            {# Campo escondido para o IBAN/Banco selecionado #}
            <input type="hidden" name="selected_bank_iban" id="id_selected_bank_iban" value="">

            {# ---------------------- ETAPA 1: ESCOLHER VALOR (IMAGEM 1) ---------------------- #}
            <div id="step-1" class="step-container active">
                <h3 class="step-title-custom">Recarga</h3>
                <p class="step-info">Selecione ou insira o valor do dep√≥sito.</p>

                <div class="valor-rapido-grid">
                    {% for deposit_value in level_deposits_list %}
                        <button type="button" class="amount-button" data-amount="{{ deposit_value }}">
                            {{ deposit_value|floatformat:0 }}
                        </button>
                    {% empty %}
                        <p class="error-message">Nenhum valor de dep√≥sito de N√≠vel encontrado. Contacte o suporte.</p>
                    {% endfor %}
                </div>

                <div class="form-group-custom">
                    <label for="id_custom_amount" class="input-label-custom">Valor do Dep√≥sito</label>
                    <input type="number" id="id_custom_amount" placeholder="Ou insira outro valor" min="100" class="custom-input-field">
                </div>
                
                <button type="button" class="next-button primary-button" data-next-step="2" id="btn-step-1-next" disabled>
                    Pr√≥xima Etapa (Pagar) ‚û°Ô∏è
                </button>
            </div>

            {# ---------------------- ETAPA 2: PAGAR / SELECIONAR BANCO (IMAGEM 2 & 3) ---------------------- #}
            <div id="step-2" class="step-container" style="display: none;">
                <div class="jackpay-box">
                    <img src="{% static 'images/jackpay_logo.png' %}" alt="JackPay Logo" class="jackpay-logo">
                    <div class="jackpay-header">
                        <p class="jackpay-title">M√©todo de Pagamento</p>
                        <select id="bank-select" class="bank-select-field">
                            <option value="" disabled selected>Escolha um Banco</option>
                            {% for bank_detail in platform_bank_details %}
                                <option value="{{ forloop.counter }}" data-iban="{{ bank_detail.IBAN }}" data-holder="{{ bank_detail.account_holder_name }}" data-bank-name="{{ bank_detail.bank_name }}">
                                    {{ bank_detail.bank_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="bank-info-display" class="bank-info-display" style="display: none;">
                        {# Detalhes do Banco Selecionado ser√£o injetados aqui via JS #}
                        <div class="info-row">
                            <label>M√©todo de Pagamento</label>
                            <span id="display-bank-name">ATL</span>
                            <button type="button" class="copy-detail" data-copy-target="display-bank-name">üìã</button>
                        </div>
                        <div class="info-row">
                            <label>Nome do Usu√°rio</label>
                            <span id="display-holder-name">Paiva De Oliveira Diamantino Burica</span>
                            <button type="button" class="copy-detail" data-copy-target="display-holder-name">üìã</button>
                        </div>
                        <div class="info-row">
                            <label>N√∫mero da Conta</label>
                            <span id="display-iban">005500005136914310187</span>
                            <button type="button" class="copy-detail" data-copy-target="display-iban">üìã</button>
                        </div>
                        <div class="info-row">
                            <label>Valor do Pagamento</label>
                            <span id="display-amount-text" class="amount-highlight">0.00</span>
                            <button type="button" class="copy-detail" data-copy-target="display-amount-text">üìã</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="next-button primary-button large-button" data-next-step="3" id="btn-step-2-next" disabled>
                    Pagar e Pr√≥ximo (Comprovativo) ‚û°Ô∏è
                </button>
                <button type="button" class="prev-button secondary-button large-button" data-prev-step="1">
                    Voltar √† Etapa 1
                </button>
            </div>

            {# ---------------------- ETAPA 3: COMPROVATIVO (IMAGEM 3) ---------------------- #}
            <div id="step-3" class="step-container" style="display: none;">
                <h3 class="step-title-custom">Comprovativo</h3>

                {# ESTILO DO UPLOAD IMITANDO A IMAGEM #}
                <div class="upload-area-custom">
                    <label for="{{ form.proof_of_payment.id_for_label }}" class="upload-label-icon">
                        <i class="fas fa-cloud-upload-alt upload-icon-large"></i>
                        <span id="file-name-display">Carregar comprovante de pagamento</span>
                    </label>
                    <input type="file" name="{{ form.proof_of_payment.name }}" id="{{ form.proof_of_payment.id_for_label }}" accept="image/*" required class="file-input-custom">
                </div>

                <div class="form-group-custom mt-20">
                    <label for="id_payer_name" class="input-label-custom">Nome do Pagador</label>
                    <input type="text" name="payer_name_display" id="id_payer_name" placeholder="O seu nome na conta banc√°ria" required class="custom-input-field">
                </div>

                <button type="submit" class="submit-button success-button large-button" id="submit-deposit-button" disabled>
                    Enviar
                </button>
                <button type="button" class="prev-button secondary-button large-button" data-prev-step="2">
                    Etapa anterior
                </button>
            </div>
        </form>
    </div>
{% endif %}

<style>
    /* ------------------------------------------------------------------- */
    /* ESTILOS DE DEPOSITO PERSONALIZADOS PARA JACKPAY / 3 ETAPAS */
    /* ------------------------------------------------------------------- */

    /* Fundo Principal */
    body {
        background-color: #f7f7f7;
        color: #333;
        font-family: Arial, sans-serif;
    }

    /* Cabe√ßalho e Contentor Principal */
    .page-header {
        display: none; /* O t√≠tulo "Dep√≥sito" j√° est√° no JackPay Header */
    }
    .page-content, .success-screen {
        background-color: #ffffff;
        padding: 20px 20px 40px 20px;
        margin: 0 auto;
        max-width: 400px; /* Mais estreito para mobile-first */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 0;
        min-height: 100vh; /* Ocupa a altura total em mobile */
    }
    
    .step-title-custom {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    .step-info {
        text-align: center;
        color: #6c757d;
        margin-bottom: 20px;
        font-size: 0.95rem;
    }

    /* --- Indicador de Etapas (JackPay Style) --- */
    .step-indicator-jackpay {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0 30px 0;
        position: relative;
    }
    .step-indicator-jackpay .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 0;
        text-align: center;
    }
    .step-indicator-jackpay .step-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        z-index: 20;
        border: 2px solid #ccc;
    }
    .step-indicator-jackpay .step-circle.active {
        background-color: #38c172; /* Cor de sucesso/ativo */
        color: white;
        border-color: #38c172;
    }
    .step-indicator-jackpay .step-line {
        flex: 1;
        height: 3px;
        background-color: #e9ecef;
        position: absolute;
        top: 17px;
        left: 0;
        right: 0;
        margin: 0 15%; /* Ajusta o in√≠cio/fim da linha */
        z-index: 10;
    }
    .step-indicator-jackpay span {
        font-size: 0.8rem;
        margin-top: 5px;
        color: #6c757d;
    }
    /* Estilos para a linha quando o passo anterior estiver completo (n√£o estritamente necess√°rio no JS, mas bom para CSS) */
    .step-indicator-jackpay .step-item:nth-child(1) ~ .step-line {
        /* L√≥gica complexa para preenchimento da linha omitida para simplicidade */
    }


    /* --- ETAPA 1: Sele√ß√£o de Valor (Grid) --- */
    .valor-rapido-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }
    .amount-button {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
        padding: 15px 5px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.1rem;
    }
    .amount-button.active {
        background-color: #fbbc05; /* Amarelo/Dourado como na imagem 1 */
        color: #111;
        border-color: #fbbc05;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .form-group-custom {
        margin-bottom: 20px;
    }
    .input-label-custom {
        display: block;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    .custom-input-field {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
    }


    /* --- ETAPA 2: JackPay Look (Pagar) --- */
    .jackpay-box {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 25px;
    }
    .jackpay-logo {
        display: none; /* A logo da JackPay na imagem √© um placeholder */
    }
    .jackpay-header {
        background-color: #e8eaf6; /* Cor de fundo suave */
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #dcdcdc;
    }
    .jackpay-title {
        font-weight: bold;
        color: #6f42c1;
        font-size: 1.1rem;
        margin: 0;
    }
    .bank-select-field {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    
    .bank-info-display {
        padding: 15px;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-row label {
        font-weight: normal;
        color: #6c757d;
        flex: 1;
    }
    .info-row span {
        font-weight: bold;
        color: #333;
        margin-right: 10px;
        text-align: right;
        word-break: break-word; /* Para n√∫meros longos */
    }
    .info-row .amount-highlight {
        color: #fbbc05; /* Amarelo */
        font-size: 1.05rem;
    }
    .copy-detail {
        background: none;
        border: none;
        color: #6f42c1;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 0 5px;
    }
    
    /* --- ETAPA 3: Upload do Comprovativo (Estilo Imagem 3) --- */
    .upload-area-custom {
        text-align: center;
        margin: 30px 0;
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px 20px;
        background-color: #fafafa;
    }
    .upload-label-icon {
        display: block;
        cursor: pointer;
        color: #6c757d;
    }
    .upload-icon-large {
        font-size: 3rem;
        color: #6f42c1;
        margin-bottom: 10px;
        display: block;
    }
    .file-input-custom {
        display: none; /* Esconder o input de arquivo padr√£o */
    }
    .mt-20 {
        margin-top: 20px;
    }

    /* --- Bot√µes e Estilos Comuns --- */
    .large-button {
        padding: 15px !important;
        font-size: 1.1rem !important;
        margin-top: 20px !important;
        width: 100%;
        font-weight: bold;
        border-radius: 8px;
    }
    .primary-button { background-color: #6f42c1; color: #fff; }
    .secondary-button { background-color: #6c757d; color: #fff; }
    .success-button { background-color: #38c172; color: #fff; }

    /* --- Tela de Sucesso Reestilizada --- */
    .success-screen {
        text-align: center;
        padding-top: 50px;
        min-height: 80vh;
    }
    .success-icon-custom {
        font-size: 4rem;
        color: #38c172;
        margin-bottom: 20px;
    }
    .success-screen h2 {
        color: #333;
        font-size: 1.8rem;
        margin-bottom: 10px;
    }
    .success-screen p {
        color: #6c757d;
        margin-bottom: 30px;
    }
    .back-to-menu-button {
        background-color: #6f42c1;
        color: white;
        text-decoration: none;
        display: inline-block;
        width: auto;
        padding: 15px 30px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Elementos Comuns e Estado ---
        const steps = [
            document.getElementById('step-1'),
            document.getElementById('step-2'),
            document.getElementById('step-3')
        ];
        const indicators = [
            document.getElementById('indicator-1'),
            document.getElementById('indicator-2'),
            document.getElementById('indicator-3')
        ];
        let currentStep = 1;

        let selectedAmount = null;

        // --- Fun√ß√µes de Utilidade ---
        const formatCurrency = (value) => {
            return parseFloat(value).toFixed(2);
        };

        const updateStepVisibility = () => {
            steps.forEach((step, index) => {
                const stepNum = index + 1;
                step.style.display = stepNum === currentStep ? 'block' : 'none';

                if (indicators[index]) {
                    indicators[index].classList.toggle('active', stepNum <= currentStep);
                    indicators[index].innerText = stepNum; // Garante que o n√∫mero est√° vis√≠vel
                }
            });
            window.scrollTo(0, 0);
        };

        // --- L√≥gica Geral de Navega√ß√£o (MANTIDA a estrutura) ---
        document.querySelectorAll('.next-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const nextStep = parseInt(e.target.dataset.nextStep);
                
                // Valida√ß√£o Espec√≠fica para a Etapa 1
                if (currentStep === 1) {
                    if (selectedAmount === null || parseFloat(selectedAmount) <= 0) {
                        alert('Por favor, selecione ou insira um valor de dep√≥sito v√°lido.');
                        return;
                    }
                }
                
                // Valida√ß√£o Espec√≠fica para a Etapa 2
                if (currentStep === 2) {
                    const selectedBankOption = document.getElementById('bank-select').value;
                    if (!selectedBankOption) {
                        alert('Por favor, selecione um banco para continuar.');
                        return;
                    }
                    // For√ßa a atualiza√ß√£o do campo hidden para o IBAN
                    const selectedBankElement = document.getElementById('bank-select').options[document.getElementById('bank-select').selectedIndex];
                    const iban = selectedBankElement.getAttribute('data-iban');
                    document.getElementById('id_selected_bank_iban').value = iban;
                }

                currentStep = nextStep;
                updateStepVisibility();
            });
        });

        document.querySelectorAll('.prev-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const prevStep = parseInt(e.target.dataset.prevStep);
                currentStep = prevStep;
                updateStepVisibility();
            });
        });


        // --- Etapa 1: Sele√ß√£o do Valor (Recarga) ---
        const amountButtons = document.querySelectorAll('.amount-button');
        const customAmountInput = document.getElementById('id_custom_amount');
        const amountHiddenInput = document.getElementById('id_amount');
        const nextButtonStep1 = document.getElementById('btn-step-1-next');

        const updateAmountSelection = (amount) => {
            selectedAmount = amount;
            amountHiddenInput.value = amount;
            nextButtonStep1.disabled = (parseFloat(amount) <= 0);

            // Atualiza o display do valor na Etapa 2
            const displayAmount = document.getElementById('display-amount-text');
            if (displayAmount) {
                displayAmount.innerText = formatCurrency(amount) + " KZ";
            }
        };
        
        // Sele√ß√£o por Bot√£o
        amountButtons.forEach(button => {
            button.addEventListener('click', () => {
                amountButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                customAmountInput.value = ''; // Limpa o input personalizado
                updateAmountSelection(button.dataset.amount);
            });
        });

        // Sele√ß√£o por Input Personalizado
        customAmountInput.addEventListener('input', () => {
            amountButtons.forEach(btn => btn.classList.remove('active'));
            const value = customAmountInput.value.trim();
            if (value && parseFloat(value) > 0) {
                updateAmountSelection(value);
            } else {
                updateAmountSelection(null);
            }
        });


        // --- Etapa 2: Sele√ß√£o do Banco (Pagar) ---
        const bankSelect = document.getElementById('bank-select');
        const bankInfoDisplay = document.getElementById('bank-info-display');
        const nextButtonStep2 = document.getElementById('btn-step-2-next');

        bankSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const bankName = selectedOption.getAttribute('data-bank-name');
            const holderName = selectedOption.getAttribute('data-holder');
            const iban = selectedOption.getAttribute('data-iban');

            if (iban) {
                document.getElementById('display-bank-name').innerText = bankName;
                document.getElementById('display-holder-name').innerText = holderName;
                document.getElementById('display-iban').innerText = iban;
                bankInfoDisplay.style.display = 'block';
                nextButtonStep2.disabled = false;
            } else {
                bankInfoDisplay.style.display = 'none';
                nextButtonStep2.disabled = true;
            }
        });

        // L√≥gica de Copiar Detalhes
        document.querySelectorAll('.copy-detail').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.dataset.copyTarget;
                const textToCopy = document.getElementById(targetId).innerText.replace(' KZ', '').trim();
                
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        const originalText = e.target.innerText;
                        e.target.innerText = '‚úÖ';
                        setTimeout(() => {
                            e.target.innerText = originalText;
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Falha ao copiar: ', err);
                        alert('Falha ao copiar. Tente manualmente.');
                    });
            });
        });


        // --- Etapa 3: Comprovativo ---
        const proofInput = document.getElementById('{{ form.proof_of_payment.id_for_label }}');
        const fileNameDisplay = document.getElementById('file-name-display');
        const submitButton = document.getElementById('submit-deposit-button');
        const payerNameInput = document.getElementById('id_payer_name');
        const payerNameHidden = document.getElementById('id_payer_name_hidden');

        // Fun√ß√£o para verificar se o envio √© permitido
        const checkSubmissionEligibility = () => {
            const fileUploaded = proofInput && proofInput.files.length > 0;
            const nameProvided = payerNameInput.value.trim().length > 0;
            const amountValid = selectedAmount !== null && parseFloat(selectedAmount) > 0;
            
            submitButton.disabled = !(fileUploaded && nameProvided && amountValid);
        };
        
        // Listener para o input de arquivo
        if (proofInput) {
            proofInput.addEventListener('change', () => {
                if (proofInput.files.length > 0) {
                    fileNameDisplay.innerText = `Arquivo: ${proofInput.files[0].name}`;
                } else {
                    fileNameDisplay.innerText = 'Carregar comprovante de pagamento';
                }
                checkSubmissionEligibility();
            });
        }
        
        // Listener para o nome do pagador
        payerNameInput.addEventListener('input', () => {
            // Sincroniza o valor com o campo Django oculto
            payerNameHidden.value = payerNameInput.value.trim(); 
            checkSubmissionEligibility();
        });


        // Inicia na Etapa 1
        updateStepVisibility();
    });
</script>
{% endblock %}

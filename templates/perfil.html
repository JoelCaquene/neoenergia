{% extends "base.html" %}
{% load static %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <i class="fas fa-user-circle profile-icon-lg"></i>
        <h1>Meu Perfil</h1>
        {# LINHA 11 CORRIGIDA: Uso de user.get_username para obter o identificador de login em vez de user.username #}
        <p class="user-welcome-text">Bem-vindo(a), **{{ user.get_full_name|default:user.get_username }}**!</p> 
    </div>

    {# Mensagens de feedback do Django #}
    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                <p class="message {{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="content-cards-wrapper">
        
        {# ------------------------------------- #}
        {# CARD DE RESUMO DA CONTA (INDICADORES HORIZONTAIS) #}
        {# ------------------------------------- #}
        <div class="profile-card summary-card">
            <h3 class="card-title-header">
                <i class="fas fa-chart-line header-icon"></i> üìä Resumo e Indicadores
            </h3>
            
            {# Indicadores em linha (Horizontal) - Adaptado para Grid de 4 #}
            <div class="account-indicators-grid">
                
                {# 1. Usu√°rio/Telefone (√çcone Azul Forte) #}
                <div class="info-item item-phone">
                    <div class="icon-wrapper"><i class="fas fa-mobile-alt"></i></div>
                    <span class="label">Telefone:</span>
                    <span class="value">{{ user.phone_number|default:'N/A' }}</span>
                </div>
                
                {# 2. Saldo Activo (√çcone Laranja Destaque) #}
                <div class="info-item item-balance">
                    <div class="icon-wrapper"><i class="fas fa-coins"></i></div>
                    <span class="label">Saldo Activo:</span>
                    <span class="value main-balance">KZ {{ user.available_balance|default:'0.00' }}</span>
                </div>
                
                {# 3. N√≠vel Activo (√çcone Verde Sucesso) #}
                <div class="info-item item-level">
                    <div class="icon-wrapper"><i class="fas fa-award"></i></div>
                    <span class="label">N√≠vel:</span>
                    <span class="value level-value">{{ user.active_level.name|default:'B√°sico' }}</span>
                </div>
                
                {# 4. Retirada Total (√çcone Roxo/Violeta) #}
                <div class="info-item item-withdraw">
                    <div class="icon-wrapper"><i class="fas fa-money-check-alt"></i></div>
                    <span class="label">Retirada Total:</span>
                    <span class="value">KZ {{ user.total_withdrawn|default:'0.00' }}</span>
                </div>
            </div>
        </div>
        
        {# --------------------------- #}
        {# BOT√ïES DE A√á√ÉO PRINCIPAIS (√öNICOS E HORIZONTAIS NA LINHA) #}
        {# --------------------------- #}
        <div class="action-buttons-card profile-card">
             <h3 class="card-title-header">
                <i class="fas fa-tools header-icon"></i> ‚öôÔ∏è A√ß√µes da Conta
            </h3>
            <div class="action-buttons-row">
                <button type="button" class="action-button primary-gradient-button" onclick="showBankForm()">
                    <i class="fas fa-credit-card"></i>
                    <span>Editar Dados Banc√°rios</span>
                </button>
                
                <a href="{% url 'logout' %}" class="action-button danger-button">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair da Conta</span>
                </a>
            </div>
        </div>
        
    </div>

    {# ---------------------------------- #}
    {# FORMUL√ÅRIO DE EDI√á√ÉO DADOS BANC√ÅRIOS #}
    {# ---------------------------------- #}
    <div id="bank-form-container" class="profile-card form-card" style="display:none;">
        <h3 class="card-title-header">
            <i class="fas fa-pen-square header-icon"></i> ‚úèÔ∏è Atualizar Dados Banc√°rios
        </h3>
        <form method="post" class="form-style">
            {% csrf_token %}
            <div class="form-group">
                <label for="{{ form.account_holder_name.id_for_label }}"><i class="fas fa-user-alt form-icon"></i> Nome Completo:</label>
                {{ form.account_holder_name }}
                {% for error in form.account_holder_name.errors %} <p class="errorlist">{{ error }}</p> {% endfor %}
            </div>
            <div class="form-group">
                <label for="{{ form.bank_name.id_for_label }}"><i class="fas fa-university form-icon"></i> Nome do Banco:</label>
                {{ form.bank_name }}
                {% for error in form.bank_name.errors %} <p class="errorlist">{{ error }}</p> {% endfor %}
            </div>
            <div class="form-group">
                <label for="{{ form.IBAN.id_for_label }}"><i class="fas fa-barcode form-icon"></i> IBAN:</label>
                {{ form.IBAN }}
                {% for error in form.IBAN.errors %} <p class="errorlist">{{ error }}</p> {% endfor %}
            </div>
            
            <div class="form-actions">
                <button type="button" class="submit-button secondary-button" onclick="hideBankForm()">
                    <i class="fas fa-times-circle"></i> Cancelar
                </button>
                <button type="submit" name="update_bank" class="submit-button primary-gradient-button">
                    <i class="fas fa-save"></i> Salvar Dados
                </button>
            </div>
        </form>
    </div>

</div>

<style>
    /* ------------------------------------------------------------------- */
    /* ESTILOS GERAIS E TIPOGRAFIA PROFISSIONAL (INTER) */
    /* ------------------------------------------------------------------- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

    :root {
        /* CORES DO TEMA AZUL ESCURO/BRILHO */
        --color-primary: #00bfff; /* Azul Neon/Ciano Brilhante */
        --color-primary-dark: #0056b3; 
        --color-background-dark: #1a2035; /* Fundo Escuro */
        --color-card-bg: #212940; /* Fundo do Card um pouco mais claro que o Body */
        --color-text-light: #e0e6f8; /* Texto Claro */
        --color-text-muted: #8899b8; /* Texto Atenuado */
        --color-danger: #ff4d4d; /* Vermelho Brilhante */
        --color-success: #39ff14; /* Verde Neon */
        --color-warning: #ffd700; /* Amarelo Ouro */
        --color-border-dark: #303a55; /* Borda Escura */
        --neon-shadow-light: 0 0 8px rgba(0, 191, 255, 0.6); /* Sombra Neon Leve */
        --neon-shadow-strong: 0 0 15px rgba(0, 191, 255, 0.8), 0 0 5px rgba(0, 191, 255, 0.4); /* Sombra Neon Forte */
    }

    body {
        background-color: var(--color-background-dark); 
        color: var(--color-text-light);
        font-family: 'Inter', sans-serif;
    }
    
    .page-container {
        padding: 20px 15px; 
        max-width: 960px;
        margin: 0 auto;
    }
    
    /* Cabe√ßalho */
    .page-header {
        text-align: center;
        padding: 10px 0 20px; 
        margin-bottom: 10px;
    }
    .profile-icon-lg {
        font-size: 3.5rem;
        color: var(--color-primary);
        text-shadow: 0 0 5px var(--color-primary); /* Brilho no √≠cone */
        margin-bottom: 10px;
    }
    .page-header h1 {
        color: var(--color-primary); 
        font-size: 2.2rem;
        font-weight: 800;
        margin: 0;
        text-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
    }
    .user-welcome-text {
        color: var(--color-text-muted);
        font-size: 1.0rem;
        font-weight: 400;
        margin-top: 5px;
    }

    /* Mensagens */
    .messages-container { margin-bottom: 20px; }
    .message {
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: var(--color-background-dark); /* Texto escuro no fundo colorido */
        box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .success { background-color: var(--color-success); color: #1a2035;}
    .error { background-color: var(--color-danger); color: #1a2035; }

    /* ------------------------------------- */
    /* CARDS GERAIS (ESTRUTURA DE CONTE√öDO) */
    /* ------------------------------------- */
    .content-cards-wrapper {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
    }
    @media (min-width: 900px) {
        .content-cards-wrapper { flex-direction: row; align-items: flex-start; }
        .summary-card { flex-basis: 70%; }
        .action-buttons-card { flex-basis: 30%; }
    }

    .profile-card {
        background-color: var(--color-card-bg);
        padding: 20px;
        border-radius: 12px;
        /* Sombra de Brilho Neon */
        box-shadow: var(--neon-shadow-light); 
        border: 1px solid var(--color-border-dark);
        transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .profile-card:hover {
        box-shadow: var(--neon-shadow-strong);
        border-color: var(--color-primary);
    }
    
    .card-title-header {
        display: flex;
        align-items: center;
        color: var(--color-primary);
        border-bottom: 1px solid var(--color-border-dark);
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .header-icon {
        margin-right: 10px;
        font-size: 1.3rem;
        color: var(--color-primary);
    }

    /* GRID DE INFORMA√á√ïES (4 INDICADORES) */
    .account-indicators-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    @media (min-width: 640px) {
        .account-indicators-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .info-item {
        background-color: #2b3550; /* Fundo do item mais escuro */
        padding: 15px 10px;
        border-radius: 10px;
        border: 1px solid #303a55;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
        transition: transform 0.2s, background-color 0.3s;
        color: var(--color-text-light);
    }
    .info-item:hover {
        transform: translateY(-4px);
        background-color: #354160;
    }
    
    /* √çcones do Indicador */
    .icon-wrapper {
        box-shadow: var(--neon-shadow-light); /* Sombra neon leve nos √≠cones */
    }

    /* Cores dos Indicadores - Mantendo o contraste Neon */
    .item-phone .icon-wrapper { background-color: #17a2b8; box-shadow: 0 0 5px #17a2b8; }
    .item-balance .icon-wrapper { background: linear-gradient(45deg, #ffd700, #ff8c00); box-shadow: 0 0 5px #ff8c00; } 
    .item-level .icon-wrapper { background-color: var(--color-success); box-shadow: 0 0 5px var(--color-success); } 
    .item-withdraw .icon-wrapper { background-color: #6f42c1; box-shadow: 0 0 5px #6f42c1; } 

    .info-item .label {
        color: var(--color-text-muted); 
    }
    .info-item .value {
        color: var(--color-text-light);
    }
    .main-balance {
        color: var(--color-primary); /* Valor principal em azul neon */
        text-shadow: 0 0 3px rgba(0, 191, 255, 0.4);
    }
    .level-value {
        color: var(--color-success);
    }
    
    /* ------------------------------------- */
    /* BOT√ïES DE A√á√ÉO */
    /* ------------------------------------- */
    
    .action-button {
        /* Ajuste de sombra e cor para Dark Mode */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); 
    }
    .action-button:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }
    
    /* Bot√£o com Gradiente Prim√°rio (Neon) */
    .primary-gradient-button {
        background: linear-gradient(90deg, #00bfff, #007bff); /* Gradiente Azul Neon */
        color: #fff;
        border: 1px solid #00bfff;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }
    .primary-gradient-button:hover {
        box-shadow: var(--neon-shadow-strong);
    }
    
    /* Bot√£o Perigo (Sair - Destaque) */
    .danger-button {
        background-color: var(--color-danger); 
        color: var(--color-background-dark);
        font-weight: 700;
        border: 1px solid var(--color-danger);
    }
    .danger-button:hover {
        background-color: #ff6666; 
        box-shadow: 0 0 10px var(--color-danger);
    }

    /* ------------------------------------- */
    /* FORMUL√ÅRIO */
    /* ------------------------------------- */
    .form-style label {
        color: var(--color-text-light);
    }
    /* ALTERA√á√ïES AQUI: AUMENTAR ALTURA E MUDAR FUNDO PARA BRANCO */
    .form-style input {
        width: 100%;
        padding: 14px; /* Aumentei de 12px para 14px para alargar */
        border: 1px solid var(--color-border-dark);
        background-color: #ffffff; /* Fundo do input BRANCO */
        color: #000000; /* Texto digitado PRETO */
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1.0rem;
        /* Adicionei uma sombra interna sutil para simular profundidade e o foco neon no focus */
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); 
    }
    .form-style input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(0, 191, 255, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.2); /* Mant√©m a sombra interna e adiciona o brilho neon */
    }
    /* FIM DAS ALTERA√á√ïES NO INPUT */
    
    .form-icon {
        color: var(--color-text-muted);
    }
    
    .secondary-button {
        background-color: #55607b; /* Azul/Cinza escuro para secund√°rio */
        color: var(--color-text-light);
    }
    .secondary-button:hover {
        background-color: #6a748f;
    }

    .errorlist {
        color: var(--color-danger);
    }

    /* Mantenha as media queries e estilos restantes */
    @media (max-width: 899px) { .action-buttons-card { margin-bottom: 20px; } }
    .action-buttons-row { display: flex; flex-direction: column; gap: 15px; }
    @media (min-width: 640px) { .action-buttons-row { flex-direction: row; justify-content: space-between; } }
    @media (min-width: 900px) { .action-buttons-row { flex-direction: column; } .action-button { width: 100%; } }
    .action-button { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 15px; border-radius: 8px; font-weight: 600; font-size: 1.0rem; text-decoration: none; border: none; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; }
    .action-button i { font-size: 1.2rem; margin-right: 10px; }
    .form-group { margin-bottom: 20px; }
    .form-actions { margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end; }
    .submit-button { flex-grow: 1; max-width: 200px; padding: 12px; text-align: center; font-weight: 700; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; }
    @media (max-width: 500px) { .form-actions { flex-direction: column; } .submit-button { max-width: 100%; } }

</style>

<script>
    const bankFormContainer = document.getElementById('bank-form-container');

    // Fun√ß√£o que garante que o formul√°rio √© exibido
    function showBankForm() {
        bankFormContainer.style.display = 'block';
        window.scrollTo(0, bankFormContainer.offsetTop - 20); // Rola para o formul√°rio
    }

    // Fun√ß√£o para ocultar o formul√°rio
    function hideBankForm() {
        bankFormContainer.style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function() {
        // 1. Verifica se o formul√°rio deve ser exibido por causa de erros do Django
        const hasFormErrors = document.querySelector('#bank-form-container .errorlist');
        if (hasFormErrors) {
            // Se houver erros no formul√°rio, ele deve ser exibido
            showBankForm();
        }
    });
    
</script>
{% endblock %}

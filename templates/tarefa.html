{% extends "base.html" %}
{% load static %}

{% block title %}Tarefas - Máquina de Ganhos Diários{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>JOGO AUTOMÁTICO DE GANHOS</h1>
    </div>

    <div class="ticker-board-container">
        {% if has_active_level %}
        <div class="ticker-board">
            <div class="ticker-item">
                <span class="ticker-label">Nível Ativo:</span>
                <span class="ticker-value level-name">{{ active_level.level.name|default:"Nenhum" }}</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-label">Ganho Diário:</span>
                <span class="ticker-value gain-amount">KZ {{ active_level.level.daily_gain|default:"0.00" }}</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-label">Status do Ciclo:</span>
                <span class="ticker-value status-text" id="cycle-status">...</span>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="task-machine-container counter-style">
        <div class="display-panel">
            <p class="display-label">PRÓXIMO GANHO EM:</p>
            <div id="countdown-display" class="digital-counter">
                <span class="digit-box" id="hours-display">00</span><span class="separator">:</span>
                <span class="digit-box" id="minutes-display">00</span><span class="separator">:</span>
                <span class="digit-box" id="seconds-display">00</span>
            </div>
        </div>

        <div class="machine-controls">
            {# NOVO HTML PARA O PAINEL DE LUZ ÚNICA LED VERDE PERSONALIZADA #}
            <div class="status-led-single">
                <div class="custom-led" id="single-green-led"></div>
            </div>
            
            <p id="task-message" class="control-message">Contagem regressiva automática de 24h.</p>

            {# O botão é desabilitado/habilitado pelo JS e pela lógica do Django #}
            <button id="work-button" class="action-button primary-action-button">INICIAR CICLO</button>
        </div>
    </div>
    
    {% if not has_active_level %}
    <div class="tasks-info-standalone">
        <p style="color: var(--warning-color);">⚠️ &nbsp; **MÁQUINA EM STANDBY.** &nbsp; ⚠️</p>
        <p style="font-size: 0.9rem;">Compre um **Nível/Produto** para liberar e iniciar o ciclo de ganhos diários. Visite o menu **NÍVEL**.</p>
    </div>
    {% endif %}


    {# Mensagens do Django (mantido no final) #}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <script>
        // Variável de tempo inicial do Django (se o nível estiver ativo)
        const initialTimeRemaining = {{ cooldown_seconds_remaining|default:0 }}; 
        // Se o usuário tem nível ativo, a máquina está "trabalhando" no ciclo; se não, está em "idle"
        const hasActiveLevel = {{ has_active_level|lower }}; 

        document.addEventListener("DOMContentLoaded", function() {
            const workButton = document.getElementById('work-button');
            const taskMessage = document.getElementById('task-message');
            // Mudei o seletor para pegar o elemento dentro do novo ticker-board
            const cycleStatus = document.getElementById('cycle-status'); 
            const hoursDisplay = document.getElementById('hours-display');
            const minutesDisplay = document.getElementById('minutes-display');
            const secondsDisplay = document.getElementById('seconds-display');
            
            // Novo seletor para o LED único
            const singleGreenLed = document.getElementById('single-green-led');

            // Novo elemento para o ticker (para atualizar o Status se ele existir)
            const tickerStatusElement = document.querySelector('.ticker-value.status-text');

            const MAX_TIME = 86400; // 24 horas em segundos
            let timeRemaining = initialTimeRemaining; 
            let countdownInterval;

            // Define o estado inicial de "trabalho" baseado no tempo restante (se houver nível ativo)
            let isWorking = hasActiveLevel && timeRemaining > 0;
            let isCompleted = hasActiveLevel && timeRemaining <= 0;

            // --- FUNÇÃO PARA PEGAR O CSRF TOKEN DO COOKIE (MANTIDA) ---
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // --- FUNÇÕES DE CONTROLE DE UI (ADAPTADAS PARA O LED ÚNICO VERDE) ---

            function updateLightStatus(status) {
                // Limpa todas as classes de status
                singleGreenLed.classList.remove('active', 'pulsing', 'standby');
                
                let buttonText = "INICIAR CICLO";
                let statusText = "INATIVO (Aguardando Início)";
                
                if (status === 'running') {
                    // Verde pulsante (indicando trabalho/contagem)
                    singleGreenLed.classList.add('pulsing'); 
                    workButton.disabled = true;
                    buttonText = "CICLO EM ANDAMENTO...";
                    statusText = "ATIVO (Gerando Ganhos)";
                } else if (status === 'completed') {
                    // Verde ativo/sólido (indicando conclusão)
                    singleGreenLed.classList.add('active'); 
                    workButton.disabled = false;
                    buttonText = "RECEBER GANHO (Ciclo Completo)";
                    statusText = "CONCLUÍDO (Pronto para o Ganho)";
                } else if (status === 'no_level') {
                    // Desligado/Standby (Nenhum Nível)
                    singleGreenLed.classList.add('standby'); // Mudei para uma cor mais sutil (cinza)
                    workButton.disabled = true;
                    buttonText = "NÍVEL INATIVO";
                    statusText = "STANDBY (Nível Requerido)";
                } else { // 'idle' - Pronto para iniciar
                    // Desligado/Standby (Pronto para Iniciar)
                    singleGreenLed.classList.add('standby');
                    workButton.disabled = hasActiveLevel ? false : true; 
                    if (!hasActiveLevel) {
                        buttonText = "NÍVEL INATIVO";
                        statusText = "STANDBY (Nível Requerido)";
                    }
                }

                workButton.textContent = buttonText;
                
                // Atualiza o status de texto do Ticker
                if (tickerStatusElement) {
                    tickerStatusElement.textContent = statusText;
                }
                
                // Se não tem nível ativo, o contador é 00:00:00.
                if (!hasActiveLevel) {
                    hoursDisplay.textContent = '00';
                    minutesDisplay.textContent = '00';
                    secondsDisplay.textContent = '00';
                    taskMessage.textContent = "Ative um Nível para iniciar a contagem de 24h.";
                }
            }
            
            function formatTime(totalSeconds) {
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return { hours, minutes, seconds };
            }

            function updateCountdownDisplay() {
                if (timeRemaining > 0) {
                    const { hours, minutes, seconds } = formatTime(timeRemaining);
                    hoursDisplay.textContent = hours;
                    minutesDisplay.textContent = minutes;
                    secondsDisplay.textContent = seconds;
                    taskMessage.textContent = "Próxima geração de lucros em...";
                } else {
                    hoursDisplay.textContent = '00';
                    minutesDisplay.textContent = '00';
                    secondsDisplay.textContent = '00';
                    taskMessage.textContent = "CICLO COMPLETO! Clique para receber seu ganho!";
                    
                    clearInterval(countdownInterval); 
                    updateLightStatus('completed');
                }
            }

            function startCountdown() {
                if (!hasActiveLevel) return; // Não inicia se não tem nível ativo

                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                
                if (timeRemaining > 0) {
                    isWorking = true;
                    updateLightStatus('running');
                    updateCountdownDisplay(); 
                    
                    countdownInterval = setInterval(() => {
                        if (timeRemaining > 0) {
                            timeRemaining--;
                            updateCountdownDisplay();
                        } else {
                            // Zerou
                            isWorking = false; // Parou de trabalhar
                            updateCountdownDisplay(); 
                        }
                    }, 1000);
                } else {
                    isWorking = false; 
                    updateCountdownDisplay(); 
                }
            }
            
            // --- FUNÇÃO AJAX PRINCIPAL (MANTIDA) ---

            function checkAndGenerateGain(isInitialStart = false) {
                if (!hasActiveLevel) {
                    taskMessage.textContent = "ERRO: Nível não ativo. Compre um Nível para prosseguir.";
                    updateLightStatus('no_level');
                    return;
                }
                
                const csrftoken = getCookie('csrftoken'); 
                
                updateLightStatus('running'); 
                workButton.disabled = true;
                taskMessage.textContent = "Comunicando com o sistema... Aguarde.";
                
                // *** ALTERAÇÃO CRÍTICA: Aponta para a própria URL 'tarefa' (que é a view que processa o POST) ***
                fetch("{% url 'tarefa' %}", { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken 
                    },
                    body: JSON.stringify({ action: 'process_gain', is_initial_start: isInitialStart }) 
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dailyGain = data.daily_gain || "{{ active_level.level.daily_gain|default:'0.00' }}"; 
                        
                        taskMessage.textContent = `GANHO RECEBIDO! ${data.message || 'Ciclo reiniciado.'} Ganho: KZ ${dailyGain}.`;
                        
                        // O backend agora retorna o novo tempo restante ou o tempo total (MAX_TIME)
                        timeRemaining = data.new_time_remaining || MAX_TIME; 
                        isWorking = true;
                        
                        // Atualiza o valor do Ganho Diário no Ticker
                        const tickerGainElement = document.querySelector('.ticker-value.gain-amount');
                        if (tickerGainElement) {
                            tickerGainElement.textContent = `KZ ${parseFloat(dailyGain).toFixed(2)}`;
                        }

                        startCountdown(); 
                        
                    } else {
                        taskMessage.textContent = data.message || "Falha ao processar a tarefa.";
                        
                        if (data.time_remaining !== undefined) {
                            timeRemaining = data.time_remaining;
                            if (timeRemaining > 0) {
                                startCountdown(); 
                            } else {
                                updateLightStatus('completed');
                            }
                        } else {
                            if (isWorking) {
                                updateLightStatus('running'); 
                            } else {
                                updateLightStatus('idle'); 
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro de Rede:', error);
                    taskMessage.textContent = "Erro de conexão. Verifique sua rede. Tente novamente.";
                    updateLightStatus('no_level'); 
                });
            }
            
            // --- INICIALIZAÇÃO E EVENT LISTENERS (MANTIDOS E ADAPTADOS) ---

            if (workButton) {
                workButton.addEventListener('click', function() {
                    if (hasActiveLevel) {
                        // Clica para INICIAR o ciclo (tempo <= 0) ou para receber o ganho e REINICIAR o ciclo (tempo <= 0)
                        checkAndGenerateGain(isInitialStart = timeRemaining <= 0); 
                    } else {
                        updateLightStatus('no_level');
                    }
                });
            }
            
            // Lógica de inicialização unificada
            if (hasActiveLevel) {
                if (initialTimeRemaining > 0) {
                    startCountdown(); 
                } else if (initialTimeRemaining <= 0) {
                    updateLightStatus('completed');
                    taskMessage.textContent = "CICLO COMPLETO! Clique para receber seu ganho!";
                } else {
                    // Estado inicial (Tempo 0, mas pode iniciar)
                    updateLightStatus('idle'); 
                    taskMessage.textContent = "Máquina pronta! Clique em INICIAR CICLO para começar o ciclo de 24 horas.";
                }
            } else {
                updateLightStatus('no_level'); 
            }
        });
    </script>
</div>
<style>
/* ------------------------------------ */
/* ESTILOS GERAIS - Fundo Branco Adicionado */
/* ------------------------------------ */
:root {
    --primary-color: #87CEEB; /* Azul Claro / Sky Blue */
    --secondary-color: #4CAF50; /* Verde */
    --dark-bg: #1a1a1a; /* Fundo Escuro (Usado para caixas, não o fundo da página) */
    --medium-bg: #2a2a2a; /* Fundo Médio */
    --danger-color: #D32F2F; /* Vermelho */
    --warning-color: #FFC107; /* Amarelo */
    --digital-green: #00FF00; /* Novo - Verde Digital */
    --custom-green: #2ecc71; /* Verde Bonito */
    --custom-green-glow: #27ae60; /* Sombra do Verde */
}

/* Fundo da Página (O MAIS IMPORTANTE: FUNDO BRANCO) */
body {
    background-color: #FFFFFF !important; /* Fundo Branco */
}

.page-container { 
    padding: 10px; 
    background-color: #FFFFFF; /* Garante que o container principal é branco */
    min-height: 100vh;
    color: var(--dark-bg); /* Cor do texto agora é escura */
}

.page-header { 
    background-color: #f0f0f0; /* Fundo claro para o cabeçalho */
    border-bottom: 3px solid var(--primary-color); 
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
    border-radius: 8px;
}
.page-header h1 { 
    color: var(--dark-bg); /* Título escuro */
    text-shadow: none; /* Remove o brilho */
    font-size: 1.8rem;
}

/* ------------------------------------ */
/* NOVO ESTILO: PLACA DE INFORMAÇÕES (TICKER) */
/* ------------------------------------ */
.ticker-board-container {
    overflow: hidden;
    margin-bottom: 25px;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    background-color: var(--medium-bg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.ticker-board {
    display: flex;
    white-space: nowrap;
    animation: marquee 15s linear infinite; /* Animação de deslize */
    padding: 10px 0;
}

@keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

.ticker-item {
    margin: 0 40px;
    font-size: 1rem;
    color: #fff;
    flex-shrink: 0; /* Impede que os itens encolham */
    display: flex;
    align-items: center;
}

.ticker-label {
    font-weight: normal;
    color: #bbb;
    margin-right: 5px;
}

.ticker-value {
    font-weight: bold;
    text-transform: uppercase;
}

.ticker-value.level-name {
    color: var(--primary-color);
}

.ticker-value.gain-amount {
    color: var(--digital-green); /* Destaque em verde */
}

.ticker-value.status-text {
    color: var(--warning-color);
}

.ticker-board-alert {
    padding: 10px;
    text-align: center;
    color: var(--warning-color);
    font-weight: bold;
    background-color: var(--medium-bg);
}

/* ------------------------------------ */
/* NOVO ESTILO: MÁQUINA DE CONTADOR DIGITAL */
/* ------------------------------------ */
.task-machine-container.counter-style { 
    background: var(--dark-bg); 
    border: 6px solid var(--medium-bg); /* Borda mais grossa para imitar máquina */
    border-radius: 12px; 
    max-width: 320px; 
    margin: 0 auto 30px auto; 
    padding: 20px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.8), inset 0 0 15px rgba(255, 255, 255, 0.05); 
    display: flex;
    flex-direction: column;
    align-items: center;
}

.display-panel {
    background-color: #000000; /* Tela preta do display */
    border: 3px solid #333;
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    text-align: center;
    width: 90%;
}

.display-label {
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 5px;
}

.digital-counter { 
    font-family: 'Digital-7', monospace; 
    font-size: 3.5rem; 
    font-weight: bold; 
    color: var(--digital-green); /* Cor neon verde digital */
    text-shadow: 0 0 15px rgba(0, 255, 0, 0.8); /* Brilho neon */
    display: flex;
    justify-content: center;
    gap: 5px;
}

.digit-box {
    background-color: #1a1a1a; /* Fundo para os dígitos individuais */
    padding: 2px 5px;
    border-radius: 3px;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.9);
}

.separator {
    color: var(--digital-green);
    animation: blink-colon 1s infinite;
}

@keyframes blink-colon {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.control-message { 
    font-size: 0.9rem; 
    color: #ddd; 
    margin-top: 10px; 
    text-align: center;
    min-height: 20px; /* Para evitar que o layout salte ao mudar a mensagem */
}

/* ------------------------------------ */
/* NOVO ESTILO: LED ÚNICO VERDE PERSONALIZADO */
/* ------------------------------------ */
.machine-controls {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.status-led-single {
    margin-bottom: 15px; 
    background-color: #000; 
    border-radius: 15px; /* Formato de pílula horizontal para o container */
    padding: 10px 30px; 
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.9); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    width: 50%;
    border: 2px solid #555;
}

.custom-led {
    width: 18px; /* Tamanho do LED */
    height: 18px;
    border-radius: 50%; /* Formato Circular */
    background-color: #333; /* Cor escura/desligada */
    transition: all 0.5s ease-in-out;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); /* Sombra para profundidade */
}

/* Estado Ativo/Completo (Verde Sólido e Brilhante) */
.custom-led.active {
    background-color: var(--custom-green);
    box-shadow: 0 0 15px 5px var(--custom-green-glow), 
                inset 0 0 8px rgba(255, 255, 255, 0.8);
}

/* Estado Pulsante/Running (Verde Sutil) */
@keyframes pulse-green { 
    0% { 
        opacity: 0.5;
        box-shadow: 0 0 8px 1px var(--custom-green-glow);
    } 
    50% { 
        opacity: 1;
        box-shadow: 0 0 15px 4px var(--custom-green-glow);
    }
    100% {
        opacity: 0.5;
        box-shadow: 0 0 8px 1px var(--custom-green-glow);
    }
}

.custom-led.pulsing { 
    background-color: var(--custom-green);
    animation: pulse-green 1.5s infinite alternate; 
}

/* Estado Standby/No_Level (Cinza Escuro) */
.custom-led.standby {
    background-color: #555;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
}


/* BOTÃO - Mantido o estilo original com fundo verde */
.action-button.primary-action-button { 
    background-color: var(--secondary-color); 
    background-image: linear-gradient(to top, #388E3C, #4CAF50); 
    color: #fff; 
    border: none; 
    padding: 15px 30px; 
    border-radius: 10px; 
    font-weight: bold; 
    text-transform: uppercase; 
    box-shadow: 0 5px 0 #2E7D32, 0 0 15px rgba(76, 175, 80, 0.5); 
    transition: all 0.1s ease; 
    width: 90%; 
    font-size: 1.1rem;
    margin-top: 15px;
}
.action-button.primary-action-button:active { 
    transform: translateY(3px); 
    box-shadow: 0 2px 0 #2E7D32; 
}
.action-button.primary-action-button:disabled { 
    background-color: #555 !important; 
    background-image: none !important; 
    box-shadow: 0 5px 0 #333 !important; 
    color: #bbb; 
    cursor: not-allowed;
}

/* Estilo para a mensagem de quem não tem nível ativo (em fundo branco) */
.tasks-info-standalone { 
    background-color: #f0f0f0; 
    border: 1px solid var(--warning-color); 
    color: var(--dark-bg); 
    padding: 15px; 
    margin-top: 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    text-align: center;
}
</style>
{% endblock %}
